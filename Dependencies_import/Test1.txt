'***************************************************
'Variable definition
'***************************************************

DVAR $indRefr $Pi $xInit $xCenter $xEnd $yInit[20] $theta $thetaDeg $dCplr
DVAR  $distScan $distNewfab $distSucc $distNewfabDC $distSuccDC $distChnlDC
DVAR $numDepth $numSpeed $numScan $numRadius $numDistCpl $numLengthCpl $numSWG
DVAR $depth $speed $radius $distCpl[20] $lengthCpl $scanNbr
DVAR $ii $jj
DVAR $ss



'***************************************************
'Parameters
'***************************************************

$indRefr     = 1.5
$Pi           = 4*atan(1)
$xInit        = 0.0
$xCenter      = 15
$xEnd         = 29

$distNewfab   = 0.1
$distSucc        = 0.1
$distNewfabDC   = 0.120
$distSuccDC     = 0.120
$distChnlDC     = 0.080
$distScan     = 0.000


$yInit[ 0]  =  2.0
$yInit[ 1]  =  3.4
$yInit[ 2]  =  4.8
$yInit[ 3]  =  6.2
$yInit[ 4]  =  7.6
$yInit[ 5]  =  9.0
$yInit[ 6]  = 10.4
$yInit[ 7]  = 11.8
$yInit[ 8]  = 15.0
$yInit[ 9]  = 16.4
$yInit[10] = 17.8
$yInit[11] = 19.2
$yInit[12] = 20.6
$yInit[13] = 22.0
$yInit[14] = 23.4


$distCpl[ 0]  = 0.00739
$distCpl[ 1]  = 0.00746
$distCpl[ 2]  = 0.00754
$distCpl[ 3]  = 0.00762
$distCpl[ 4]  = 0.00769
$distCpl[ 5]  = 0.00778
$distCpl[ 6]  = 0.00786
$distCpl[ 7]  = 0.00795
$distCpl[ 8]  = 0.00804
$distCpl[ 9]  = 0.00813
$distCpl[10] = 0.00822
$distCpl[11] = 0.00832
$distCpl[12] = 0.00842
$distCpl[13] = 0.00853
$distCpl[14] = 0.00864


$lengthCpl    = 0.0

$numDepth     = 1
$numSpeed     = 1
$numScan      = 1
$numDistCpl   = 15
$numLengthCpl = 1
$numSWG         = 1

$depth        = -0.220
$speed        = 40
$radius       = 60
$scanNbr      = 1


'***************************************************
'Fabrication: Laser Line 1
'***************************************************			

'~~~~ Initialisation ~~~~'
ENABLE X Y Z
METRIC 				
SECONDS
WAIT MODE NOWAIT		 
VELOCITY ON
PSOCONTROL X RESET		
PSOCONTROL X OFF
F5
ABSOLUTE
LINEAR Z0 X$xInit
DWELL 0.5




'~~~~ Loops: SWG ~~~~'
F0.3
LINEAR Z($depth/$indRefr)
DWELL 0.5

FOR $ii=0 to ($numDistCpl -1)
    ABSOLUTE
    LINEAR Y$yInit[$ii]


    FOR $ss=0 to ($scanNbr-1)
        F$speed[$ii]
        
        PSOCONTROL X ON
        DWELL 0.5
        LINEAR X$xEnd
        PSOCONTROL X OFF
        DWELL 0.5
        
        F20
        LINEAR X$xInit
        DWELL 0.5
        
    NEXT $ss
    F0.5
    INCREMENTAL
    LINEAR Y$distSucc
    ABSOLUTE
    DWELL 0.5
    

'~~~~ Finishing and Initialisation for next writting ~~~~'
F5
LINEAR Z0 X$xInit
DWELL 0.5
INCREMENTAL
LINEAR Y($distNewfab-$distSucc)
ABSOLUTE
DWELL 0.5





'~~~~ Loops: DC waveguide ~~~~'
F0.3
LINEAR Z($depth/$indRefr)
DWELL 0.5


    $dCplr    = ($distChnlDC-$distCpl[$ii])/2.
    $theta    = acos(1-$dCplr/(2*$radius))
    $thetaDeg = (180/$Pi) * $theta

    '~~~~ First harm of the Dir Cplr ~~~~'
    for $ss=0 to ($scanNbr-1)

		F$speed		
		ABSOLUTE
		PSOCONTROL X ON
		DWELL 0.5
		linear X($xCenter-2*$radius*SIN($theta)-$lengthCpl/2.)
		G17
		G3 p(270) Q(270+$thetaDeg) R$radius
		G2 P(90+$thetaDeg) q(90) R$radius
		LINEAR X($xCenter+$lengthCpl/2.)
		G2 P(90) Q(90-$thetaDeg) r$radius
		G3 p(270-$thetaDeg) q(270) r$radius
		LINEAR X$xEnd
		PSOCONTROL X OFF
		DWELL 0.5

		ABSOLUTE
		F20
		LINEAR X$xInit
		DWELL 0.5

	NEXT $ss
	

        INCREMENTAL
        LINEAR Y$distChnlDC
        DWELL 0.5
        ABSOLUTE 
        DWELL 0.5

    '~~~~ Second harm of the Dir Cplr ~~~~'
    FOR $ss=0 to ($scanNbr-1)
		F$speed
		ABSOLUTE
		PSOCONTROL X ON
		DWELL 0.5
		LINEAR X($xCenter-2*$radius*SIN($theta)-$lengthCpl/2.)
		G17
		G2 P(90) Q(90-$thetaDeg) R$radius
		G3 P(270-$thetaDeg) Q(270) R$radius
		LINEAR X($xCenter+$lengthCpl/2.)
		G3 P(270) Q(270+$thetaDeg) R$radius
		G2 P(90+$thetaDeg) Q(90) R$radius
		LINEAR X$xEnd
		PSOCONTROL X OFF
		DWELL 0.5

		ABSOLUTE
		F20
		LINEAR X$xInit
		DWELL 0.5

	NEXT $ss

    INCREMENTAL
    F5
    LINEAR Y(-$distChnlDC)
    ABSOLUTE 
    DWELL 0.5
    
    INCREMENTAL
    F5
    LINEAR Y($distSuccDC+$distChnlDC)
    ABSOLUTE 
    DWELL 0.5
NEXT $ii


'~~~~ Finishing and Initialisation for next writting ~~~~'
F0.3
LINEAR Z0 X$xInit
DWELL 0.5
INCREMENTAL
LINEAR Y($distNewfabDC-$distSuccDC)
ABSOLUTE
DWELL 0.5





